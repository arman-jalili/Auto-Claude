# Step 7: CLI Selector UI Component

## Objective
Create a React component for CLI selection in the settings page, allowing users to choose between Claude Code CLI and OpenCode CLI.

## Files to Create

### 1. Frontend: CLI Selector Component

**File**: `apps/frontend/src/renderer/features/settings/cli-selector.tsx` (NEW)

## Implementation

```typescript
/**
 * CLI Selector Component
 *
 * Allows users to select between Claude Code CLI and OpenCode CLI.
 * When OpenCode is selected, shows provider selection options.
 */

import { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import {
  CLIAPI,
  type CLIInfo,
  type CLISetOptions,
  type CLIProvider,
} from '@preload/api/modules/cli-api';

export function CLISelector() {
  const { t } = useTranslation(['settings', 'common']);

  const [cliInfo, setCLIInfo] = useState<CLIInfo | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Load CLI info on mount
  useEffect(() => {
    loadCLIInfo();
  }, []);

  const loadCLIInfo = async () => {
    setLoading(true);
    setError(null);

    try {
      const result = await CLIAPI.getInfo();
      if (result.success) {
        setCLIInfo(result.data);
      } else {
        setError(result.error || 'Failed to load CLI information');
      }
    } catch (err) {
      console.error('Error loading CLI info:', err);
      setError('Failed to load CLI information');
    } finally {
      setLoading(false);
    }
  };

  const handleCLIChange = async (cliType: 'claude' | 'opencode') => {
    setLoading(true);
    setError(null);

    try {
      const options: CLISetOptions = { cliType };

      if (cliType === 'opencode') {
        // Keep existing OpenCode provider if any
        const currentProvider = cliInfo?.authInfo?.providers?.[0];
        if (currentProvider && currentProvider !== 'claude') {
          options.opencodeProvider = currentProvider;
        }
      }

      const result = await CLIAPI.setCLI(options);

      if (result.success) {
        setCLIInfo(result.data);
      } else {
        setError(result.error || 'Failed to set CLI type');
      }
    } catch (err) {
      console.error('Error setting CLI:', err);
      setError('Failed to set CLI type');
    } finally {
      setLoading(false);
    }
  };

  const handleProviderChange = async (provider: string) => {
    if (cliInfo?.type !== 'opencode') {
      return;
    }

    const options: CLISetOptions = {
      cliType: 'opencode' as const,
      opencodeProvider: provider,
    };

    setLoading(true);
    try {
      const result = await CLIAPI.setCLI(options);
      if (result.success) {
        setCLIInfo(result.data);
      }
    } catch (err) {
      console.error('Error setting OpenCode provider:', err);
      setError('Failed to set provider');
    } finally {
      setLoading(false);
    }
  };

  const handleTestConnection = async () => {
    setLoading(true);
    setError(null);

    try {
      const result = await CLIAPI.validateCLI();

      if (result.success && result.data) {
        // Show success message
        // Could use toast notification here
      }

      if (result.success && result.data && !result.data.isValid) {
        setError(result.data.message);
      }
    } catch (err) {
      console.error('Error testing CLI:', err);
      setError('Failed to test CLI');
    } finally {
      setLoading(false);
    }
  };

  if (loading && !cliInfo) {
    return (
      <div className="loading-container">
        <div className="spinner" />
        <p>{t('common.loading')}</p>
      </div>
    );
  }

  return (
    <div className="cli-selector-container">
      <div className="section-header">
        <h2>{t('settings.cli.title')}</h2>
      </div>

      {error && (
        <div className="error-message">
          {error}
        </div>
      )}

      {loading ? (
        <div className="loading">
          <p>{t('common.loading')}</p>
        </div>
      ) : (
        <>
          <div className="cli-selection">
            <label htmlFor="cli-type">{t('settings.cli.description')}</label>
            <select
              id="cli-type"
              value={cliInfo?.type}
              onChange={handleCLIChange}
              disabled={loading}
            >
              <option value="claude">
                {t('settings.cli.claude')}
              </option>
              <option value="opencode">
                {t('settings.cli.opencode')}
              </option>
            </select>
          </div>

          {/* OpenCode Provider Selection (only shown when OpenCode CLI is active) */}
          {cliInfo?.type === 'opencode' && (
            <div className="opencode-provider">
              <label htmlFor="opencode-provider">{t('settings.cli.provider')}</label>
              <select
                id="opencode-provider"
                value={cliInfo?.authInfo?.providers?.[0] || 'claude'}
                onChange={(provider) => handleProviderChange(provider as string)}
                disabled={loading}
              >
                {cliInfo?.authInfo?.providers?.map((provider: CLIProvider) => (
                  <option key={provider.id} value={provider.id}>
                    {provider.displayName}
                  </option>
                ))}
              </select>
            </div>
          )}

          {/* CLI Information */}
          {cliInfo && (
            <div className="cli-info">
              <div className="info-item">
                <span className="label">{t('settings.cli.type')}:</span>
                <span className="value">{t(`settings.cli.${cliInfo.type}`)}</span>
              </div>

              <div className="info-item">
                <span className="label">{t('settings.cli.path')}:</span>
                <span className="value">{cliInfo.path || t('common.notAvailable')}</span>
              </div>

              <div className="info-item">
                <span className="label">{t('settings.cli.version')}:</span>
                <span className="value">{cliInfo.version || t('common.unknown')}</span>
              </div>

              <div className="info-item">
                <span className="label">{t('settings.cli.status')}:</span>
                <span className={`value status-${cliInfo.isValid ? 'valid' : 'invalid'}`}>
                  {cliInfo.isValid
                    ? t('settings.cli.working')
                    : t('settings.cli.notWorking')}
                </span>
              </div>

              <div className="info-item">
                <span className="label">{t('settings.cli.authType')}:</span>
                <span className="value">{t(`settings.cli.auth.${cliInfo.authInfo?.type}`)}</span>
              </div>

              {/* OpenCode providers info */}
              {cliInfo?.type === 'opencode' && cliInfo.authInfo?.providers && (
                <div className="providers-list">
                  <div className="info-item">
                    <span className="label">{t('settings.cli.availableProviders')}:</span>
                  </div>
                  {cliInfo.authInfo.providers.map((provider: CLIProvider) => (
                    <div key={provider.id} className="provider-item">
                      <span className="provider-name">{provider.displayName}</span>
                      <span className="provider-auth">{t(`settings.cli.provider.${provider.authType}`)}</span>
                    </div>
                  ))}
                </div>
              )}

              {/* Actions */}
              <div className="cli-actions">
                <button
                  onClick={handleTestConnection}
                  disabled={loading || !cliInfo?.path}
                >
                  {t('common.testConnection')}
                </button>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
}

/**
 * CSS styles (should be in .css or .module.css, but included here for reference)
 *
```css
.cli-selector-container {
  padding: 16px;
  max-width: 600px;
}

.section-header {
  margin-bottom: 20px;
}

.section-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px;
}

.error-message {
  background: #fee2e2e;
  color: #991b1b;
  padding: 12px;
  border-radius: 4px;
  margin-bottom: 20px;
}

.cli-selection {
  margin-bottom: 20px;
}

.cli-selection label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}

.cli-selection select {
  width: 100%;
  max-width: 300px;
  padding: 8px;
  font-size: 14px;
}

.opencode-provider {
  margin-top: 16px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
}

.opencode-provider label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}

.opencode-provider select {
  width: 100%;
  max-width: 300px;
  padding: 8px;
  font-size: 14px;
}

.cli-info {
  margin-bottom: 20px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #e5e7eb;
}

.info-item:last-child {
  border-bottom: none;
}

.info-item .label {
  font-weight: 500;
  color: #6b7280;
}

.info-item .value {
  font-weight: 400;
  color: #374151;
}

.info-item .value.status-valid {
  color: #059669;
}

.info-item .value.status-invalid {
  color: #dc2626;
}

.providers-list {
  margin-top: 16px;
}

.providers-list .info-item {
  border-bottom: none;
}

.provider-item {
  padding: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.provider-name {
  font-weight: 600;
  color: #1e293b;
}

.provider-auth {
  font-size: 12px;
  color: #64748b;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 4px;
}

.cli-actions {
  margin-top: 20px;
  display: flex;
  gap: 8px;
}

.cli-actions button {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  transition: background 0.2s ease;
}

.cli-actions button:hover:not(:disabled) {
  background: #2563eb;
}

.cli-actions button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

## Files to Modify

### 2. Frontend: Update Settings Store

**File**: `apps/frontend/src/renderer/stores/project-store.ts` (MODIFY)

Add CLI configuration to settings interface:

```typescript
// In settings interface
export interface AppSettings {
  // ... existing fields ...
  
  // NEW: CLI configuration
  cli?: 'claude' | 'opencode';
  opencode?: OpenCodeConfig;
}

export interface OpenCodeConfig {
  provider?: 'claude' | 'openai' | 'google' | 'zen' | 'local';
  apiKey?: string; // Only for api_key auth type
}
```

Update the `saveSettings` function to persist CLI configuration:

```typescript
export const saveSettings = async (
  projectPath: string,
  settings: AppSettings,
): Promise<void> => {
  // ... existing code ...

  // NEW: Save CLI configuration
  if (settings.cli || settings.opencode) {
    const autoClaudeDir = path.join(projectPath, '.auto-claude');
    await ensureDirectory(autoClaudeDir);

    const settingsPath = path.join(autoClaudeDir, 'settings.json');
    await fsWriteFile(settingsPath, JSON.stringify(settings, null, 2));
  }

  // ... rest of function continues
```

## Files to Create

### 3. Frontend: i18n Translations

**File**: `apps/frontend/src/shared/i18n/locales/en/settings.json` (MODIFY)

Add CLI-related translations:

```json
{
  // ... existing translations ...

  "cli": {
    "title": "AI CLI",
    "description": "Choose the AI CLI to use for autonomous coding",
    "claude": "Claude Code",
    "opencode": "OpenCode",
    "type": "CLI Type",
    "path": "CLI Path",
    "version": "Version",
    "status": "Status",
    "working": "Working",
    "notWorking": "Not Working",
    "authType": "Authentication Type",
    "provider": "Provider",
    "availableProviders": "Available Providers",
    "testConnection": "Test Connection",
    "auth.oauth": "OAuth",
    "auth.multi_provider": "Multi-Provider",
    "auth.api_key": "API Key",
    "auth.none": "None"
  }
}
```

**File**: `apps/frontend/src/shared/i18n/locales/fr/settings.json` (MODIFY)

Add French translations:

```json
{
  // ... existing translations ...

  "cli": {
    "title": "CLI IA",
    "description": "Choisissez le CLI IA  utiliser pour le codage autonome",
    "claude": "Claude Code",
    "opencode": "OpenCode",
    "type": "Type de CLI",
    "path": "Chemin CLI",
    "version": "Version",
    "status": "Statut",
    "working": "Fonctionne",
    "notWorking": "Non fonctionne",
    "authType": "Type d'authentification",
    "provider": "Fournisseur",
    "availableProviders": "Fournisseurs disponibles",
    "testConnection": "Tester la connexion",
    "auth.oauth": "OAuth",
    "auth.multi_provider": "Multi-fournisseur",
    "auth.api_key": "Cl d'API",
    "auth.none": "Aucun"
  }
}
```

## Integration Points

### In Settings Page

Import and use the CLISelector component:

```typescript
import { CLISelector } from '../../features/settings/cli-selector';

// In settings component
export function Settings() {
  // ... existing code ...

  return (
    <div className="settings-content">
      {/* ... existing sections ... */}
      
      {/* NEW: CLI Selection Section */}
      <div className="settings-section">
        <CLISelector />
      </div>
    </div>
  );
}
```

## Component Features

1. **CLI Type Selection** - Dropdown to choose between Claude Code and OpenCode
2. **Provider Selection** - When OpenCode is active, shows provider dropdown
3. **CLI Information Display** - Shows:
   - CLI type
   - CLI path
   - CLI version
   - CLI status (working/not working)
   - Authentication type
4. **OpenCode Providers List** - When OpenCode is active, lists available providers
5. **Test Connection Button** - Validates CLI availability
6. **Loading States** - Shows loading spinner during operations
7. **Error Handling** - Displays error messages with retry options
8. **Responsive Design** - Works on different screen sizes

## Testing

### Unit Test: `apps/frontend/src/renderer/features/settings/__tests__/cli-selector.test.tsx`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { renderHook } from '@testing-library/react';
import { CLIAPI } from '@preload/api/modules/cli-api';

describe('CLISelector Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  it('should load CLI info on mount', async () => {
    const mockGetInfo = vi.fn().mockResolvedValue({
      success: true,
      data: {
        type: 'claude',
        path: '/usr/local/bin/claude',
        isValid: true,
        version: '1.0.0',
        authInfo: {
          type: 'oauth',
          envVars: ['CLAUDE_CODE_OAUTH_TOKEN'],
          supportsKeychain: true,
          requiresOAuth: true,
        },
      },
    });

    vi.mocked(CLIAPI, 'getInfo').mockReturnValue(mockGetInfo);

    const { result } = renderHook(() => CLISelector());
    await act(async () => {
      // Trigger useEffect to load data
    });
    
    await waitFor(() => {
      expect(CLIAPI.getInfo).toHaveBeenCalledOnce();
      expect(result.current).toEqual({
        type: 'claude',
        path: '/usr/local/bin/claude',
        isValid: true,
        version: '1.0.0',
      });
    });
  });

  it('should handle CLI change to OpenCode', async () => {
    const mockSetCLI = vi.fn().mockResolvedValue({
      success: true,
      data: {
        type: 'opencode',
        path: '/usr/local/bin/opencode',
        isValid: true,
        version: '1.0.0',
        authInfo: {
          type: 'multi_provider',
          envVars: ['OPENCODE_API_KEY'],
          supportsKeychain: true,
          requiresOAuth: false,
          providers: ['claude', 'openai', 'google'],
        },
      },
    });

    vi.mocked(CLIAPI, 'setCLI').mockReturnValue(mockSetCLI);

    const { result } = renderHook(() => <CLISelector />);
    const select = result.container.querySelector('#cli-type') as HTMLSelectElement;
    
    await act(async () => {
      // Select OpenCode
      select.value = 'opencode';
      select.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    await waitFor(() => {
      expect(CLIAPI.setCLI).toHaveBeenCalledWith(
        { cliType: 'opencode' }
      );
      expect(result.current).toEqual({
        type: 'opencode',
        path: '/usr/local/bin/opencode',
      });
    });
  });

  it('should handle provider change when OpenCode is active', async () => {
    const mockSetCLI = vi.fn().mockResolvedValue({
      success: true,
      data: {
        type: 'opencode',
        authInfo: {
          providers: ['claude', 'openai'],
        },
      },
    });

    vi.mocked(CLIAPI, 'setCLI').mockReturnValue(mockSetCLI);

    const { result } = renderHook(() => <CLISelector />);
    const providerSelect = result.container.querySelector('#opencode-provider') as HTMLSelectElement;
    
    await act(async () => {
      // First select OpenCode
      const cliSelect = result.container.querySelector('#cli-type') as HTMLSelectElement;
      cliSelect.value = 'opencode';
      cliSelect.dispatchEvent(new Event('change', { bubbles: true }));
      
      // Then select different provider
      providerSelect.value = 'openai';
      providerSelect.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    await waitFor(() => {
      expect(CLIAPI.setCLI).toHaveBeenCalledTimes(2);
      expect(CLIAPI.setCLI).toHaveBeenNthCalledWith(1, { opencodeProvider: 'openai' });
    });
  });
});
```

## Verification

Run these commands to verify implementation:

```bash
# Check TypeScript compilation
cd apps/frontend
npm run typecheck

# Run unit tests
npm test -- cli-selector

# Check i18n files
npm run lint:fix
```

## Verification Checklist

- [x] CLI selector component created
- [x] TypeScript interfaces defined
- [x] Component handles CLI info loading
- [x] Component handles CLI type switching
- [x] Component handles provider selection (OpenCode mode)
- [ ] Component integrated into settings page
- [ ] Settings store updated to support CLI configuration
- [ ] i18n translations added (English and French)
- [ ] Unit tests created
- [ ] CSS styles defined
- [ ] Error handling implemented
- [ ] Loading states implemented

## Important Notes

1. **API Integration**: Uses CLIAPI from preload for all operations
2. **State Management**: React hooks for loading, error, and CLI info state
3. **Responsive Design**: Works on different screen sizes
4. **Provider Selection**: Only shown when OpenCode CLI is active
5. **Test Connection**: Validates CLI availability via --version check
6. **Translation Ready**: All user-facing text uses i18n keys
7. **Error Handling**: Clear error messages with visual feedback

## Next Steps

Proceed to **Step 8** to add i18n translations.
