# Step 1: Analyze Architecture and Design OpenCode Integration

## Objective
Design integration for OpenCode CLI as an alternative to Claude Code CLI.

## Current Architecture

### Current: Claude Code CLI Only

Auto Claude currently uses **Claude Code CLI** exclusively:
- **Authentication**: OAuth token stored in Keychain/Credential Manager
- **Agent SDK**: `claude-agent-sdk` for Claude API interactions
- **CLI Path**: Auto-detected via `which claude` or environment variable `CLAUDE_CLI_PATH`

### File: `apps/backend/core/auth.py`
- Token resolution: `CLAUDE_CODE_OAUTH_TOKEN` → Keychain → `.credentials.json`
- Platform-specific: macOS Keychain, Windows Credential Manager, Linux Secret Service

### File: `apps/backend/core/client.py`
- Creates `ClaudeSDKClient` from `claude-agent-sdk`
- Bundles Claude Code CLI internally
- Configures via `ANTHROPIC_BASE_URL`, `CLAUDE_CODE_OAUTH_TOKEN`, etc.

### Frontend: `apps/frontend/src/main/claude-profile/`
- Multi-profile credential storage
- Claude-specific token management

## OpenCode Architecture

### OpenCode CLI Features
- **Open Source**: 100% MIT licensed, 80K+ GitHub stars
- **Multi-Provider**: Supports Claude, OpenAI, Google, local models (75+ providers)
- **Agents**: "build" (full access) and "plan" (read-only)
- **Installers**: npm, brew, scoop, bun, nix
- **Config**: `.opencode/` directory for settings
- **Authentication**: OAuth (GitHub Copilot, ChatGPT), API keys, or OpenCode Zen

### OpenCode vs Claude Code

| Feature | Claude Code CLI | OpenCode CLI |
|---------|-----------------|---------------|
| Open Source | ❌ No | ✅ Yes (MIT) |
| Providers | Claude only | Claude, OpenAI, Google, local, 75+ |
| Agents | Single agent | "build" + "plan" agents |
| Auth | OAuth only | OAuth + API keys + OpenCode Zen |
| TUI | Basic | Advanced (terminal.shop creators) |
| Architecture | Monolithic | Client/Server |

## Integration Design

### CLI Selector Concept

Auto Claude should support **either** CLI:
- **Mode 1: Claude Code CLI** (current, default)
- **Mode 2: OpenCode CLI** (new)

Users select CLI via:
1. **CLI Flag**: `--cli claude` or `--cli opencode`
2. **Environment Variable**: `CLI_PROVIDER=claude|opencode`
3. **Frontend Setting**: Dropdown in Settings UI

### Configuration Structure

```
# Environment Variables
CLI_PROVIDER=claude          # or "opencode"
CLAUDE_CODE_OAUTH_TOKEN=...   # Claude CLI auth
OPENCODE_PROVIDER=claude      # OpenCode provider setting
OPENCODE_API_KEY=...          # OpenCode API key (if needed)

# Auto Claude Settings (.auto-claude/settings.json)
{
  "cli": "claude",  // or "opencode"
  "opencode": {
    "provider": "claude",  // or "openai", "google", "zen", etc.
    "apiKey": "...",
    "baseAgent": "build"  // "build" or "plan"
  }
}
```

### File Structure Changes

```
apps/backend/
├── core/
│   ├── auth.py              # Update: OpenCode token resolution
│   ├── client.py             # Update: OpenCode CLI integration
│   └── cli_manager.py         # NEW: CLI abstraction layer
├── prompts/
│   └── system/
│       └── opencode.md      # NEW: OpenCode-specific prompts
└── cli/
    └── run.py               # Update: Add --cli flag

apps/frontend/
├── src/
│   ├── main/
│   │   ├── ipc-handlers/
│   │   │   ├── cli-handlers.ts      # NEW: CLI selection handlers
│   │   │   ├── opencode-handlers.ts  # NEW: OpenCode settings
│   │   │   └── index.ts
│   ├── renderer/
│   │   └── features/
│   │       └── settings/
│   │           ├── cli-selector.tsx        # NEW: CLI selection UI
│   │           └── opencode-settings.tsx    # NEW: OpenCode config
│   └── shared/
│       ├── types/
│       │   └── cli-config.ts            # NEW: CLI configuration types
│       └── i18n/locales/
│           ├── en/settings.json             # Add CLI translations
│           └── fr/settings.json
```

## Implementation Strategy

### Phase 1: Backend CLI Abstraction

**File**: `apps/backend/core/cli_manager.py` (NEW)

```python
"""
CLI Manager - Abstraction layer for Claude Code and OpenCode CLIs
"""

import os
import shutil
import logging
from enum import Enum
from pathlib import Path
from typing import Literal

logger = logging.getLogger(__name__)


class CLIType(str, Enum):
    """Supported CLI types."""
    CLAUDE = "claude"
    OPENCODE = "opencode"


class CLIManager:
    """Manages CLI selection and execution."""

    def __init__(self, project_dir: Path):
        self.project_dir = project_dir
        self.cli_type = self._detect_cli()

    def _detect_cli(self) -> CLIType:
        """Detect which CLI to use from env var or settings."""
        # Check environment variable
        env_cli = os.environ.get("CLI_PROVIDER", "").strip().lower()
        if env_cli in (CLIType.CLAUDE.value, CLIType.OPENCODE.value):
            return CLIType(env_cli)

        # Check project settings
        settings_path = self.project_dir / ".auto-claude" / "settings.json"
        if settings_path.exists():
            import json
            with open(settings_path) as f:
                settings = json.load(f)
                cli = settings.get("cli")
                if cli in (CLIType.CLAUDE.value, CLIType.OPENCODE.value):
                    return CLIType(cli)

        # Default to Claude Code
        return CLIType.CLAUDE

    def get_cli_path(self) -> Path | None:
        """Get path to the selected CLI executable."""
        if self.cli_type == CLIType.CLAUDE:
            return self._find_claude_cli()
        else:
            return self._find_opencode_cli()

    def _find_claude_cli(self) -> Path | None:
        """Find Claude Code CLI path."""
        # Check environment variable override
        env_path = os.environ.get("CLAUDE_CLI_PATH")
        if env_path and Path(env_path).exists():
            return Path(env_path)

        # Use shutil.which to find in PATH
        path = shutil.which("claude")
        return Path(path) if path else None

    def _find_opencode_cli(self) -> Path | None:
        """Find OpenCode CLI path."""
        # Check environment variable override
        env_path = os.environ.get("OPENCODE_CLI_PATH")
        if env_path and Path(env_path).exists():
            return Path(env_path)

        # Use shutil.which to find in PATH
        path = shutil.which("opencode")
        return Path(path) if path else None

    def validate_cli(self) -> tuple[bool, str]:
        """Validate that selected CLI is available and working."""
        cli_path = self.get_cli_path()
        if not cli_path or not cli_path.exists():
            name = self.cli_type.value.title()
            return False, f"{name} CLI not found at: {cli_path or 'unknown path'}"

        try:
            result = subprocess.run(
                [cli_path, "--version"],
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.returncode == 0:
                return True, f"{self.cli_type.value.title()} CLI: {result.stdout.strip()}"
            else:
                return False, f"{self.cli_type.value.title()} CLI not responding correctly"
        except Exception as e:
            return False, f"Failed to run {self.cli_type.value} CLI: {e}"

    def get_auth_info(self) -> dict:
        """Get authentication info for selected CLI."""
        if self.cli_type == CLIType.CLAUDE:
            return {
                "type": "oauth",
                "env_vars": ["CLAUDE_CODE_OAUTH_TOKEN"],
                "supports_keychain": True,
            }
        else:
            return {
                "type": "multi_provider",
                "env_vars": ["OPENCODE_PROVIDER", "OPENCODE_API_KEY"],
                "supports_keychain": True,  # OpenCode also has keychain
            }
```

### Phase 2: Backend Authentication Updates

**File**: `apps/backend/core/auth.py` (MODIFY)

Add OpenCode authentication functions:

```python
# ... existing Claude Code auth functions ...

def get_opencode_token(config_dir: str | None = None) -> str | None:
    """
    Get OpenCode authentication token.

    OpenCode supports multiple authentication methods:
    1. OPENCODE_API_KEY (direct API key)
    2. OpenCode config in ~/.opencode/
    3. System keychain (if OpenCode stores there)

    Args:
        config_dir: Optional config directory

    Returns:
        Token string if found, None otherwise
    """
    # Check environment variable first
    token = os.environ.get("OPENCODE_API_KEY")
    if token:
        logger.debug("Found OPENCODE_API_KEY in environment")
        return token

    # Check OpenCode config directory
    opencode_config = Path.home() / ".opencode" / "config.json"
    if opencode_config.exists():
        try:
            with open(opencode_config) as f:
                config = json.load(f)
                # Check for API key or auth token
                token = config.get("apiKey") or config.get("authToken")
                if token:
                    logger.debug(f"Found token in OpenCode config: {opencode_config}")
                    return token
        except Exception as e:
            logger.debug(f"Failed to read OpenCode config: {e}")

    # Check system keychain (if OpenCode stores there)
    # Note: This may require investigation - OpenCode may use different service name
    try:
        service_name = "opencode-auth"  # May need to verify
        if is_macos():
            # Use security command to read
            # ...
            pass
        elif is_windows():
            # Read from Windows Credential Manager
            # ...
            pass
    except Exception as e:
        logger.debug(f"Failed to read OpenCode from keychain: {e}")

    return None


def get_cli_auth_token(cli_type: CLIType, config_dir: str | None = None) -> str | None:
    """
    Get authentication token based on CLI type.

    Args:
        cli_type: CLI type (CLAUDE or OPENCODE)
        config_dir: Optional config directory

    Returns:
        Token string if found, None otherwise
    """
    if cli_type == CLIType.OPENCODE:
        return get_opencode_token(config_dir)
    else:
        return get_auth_token(config_dir)  # Existing Claude function


def trigger_opencode_login() -> bool:
    """
    Trigger OpenCode login/initialization.

    OpenCode login depends on the configured provider:
    - GitHub Copilot: OAuth via GitHub
    - ChatGPT: OAuth via OpenAI
    - OpenCode Zen: Custom auth
    - API Key: Direct key input

    For now, we'll guide users to run opencode CLI directly.

    Returns:
        True if login flow initiated, False otherwise
    """
    print("\n" + "=" * 60)
    print("OPENCODE SETUP")
    print("=" * 60)
    print("\nTo set up OpenCode authentication:")
    print("  1. Run: opencode login")
    print("  2. Follow the prompts (OAuth or API key)")
    print("  3. Configure provider: opencode config")
    print("\n  Supported providers: claude, openai, google, zen, local")
    print()
    return False  # Users must run opencode manually
```

### Phase 3: Frontend Settings UI

**File**: `apps/frontend/src/renderer/features/settings/cli-selector.tsx` (NEW)

```tsx
import { useTranslation } from 'react-i18next';

export function CLISelector() {
  const { t } = useTranslation('settings');

  return (
    <div className="cli-selector">
      <label>{t('cli.title')}</label>
      <select value={selectedCLI} onChange={handleCLIChange}>
        <option value="claude">Claude Code</option>
        <option value="opencode">OpenCode</option>
      </select>

      {selectedCLI === 'opencode' && (
        <div className="opencode-settings">
          <label>{t('opencode.provider')}</label>
          <select>
            <option value="claude">Claude</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="google">Google (Gemini)</option>
            <option value="zen">OpenCode Zen</option>
            <option value="local">Local Models</option>
          </select>

          <label>{t('opencode.apiKey')}</label>
          <input type="password" />

          <button onClick={testConnection}>
            {t('common.testConnection')}
          </button>
        </div>
      )}
    </div>
  );
}
```

## Implementation Order

1. **Step 1**: Create CLI abstraction layer (`cli_manager.py`)
2. **Step 2**: Add OpenCode authentication to `auth.py`
3. **Step 3**: Update `client.py` to use CLI manager
4. **Step 4**: Add CLI selection to CLI `run.py`
5. **Step 5**: Create frontend IPC handlers for CLI selection
6. **Step 6**: Build CLI selector UI component
7. **Step 7**: Add OpenCode settings UI
8. **Step 8**: Add i18n translations
9. **Step 9**: Update documentation
10. **Step 10**: Test with both CLIs

## Backward Compatibility

- Default CLI remains "claude" (no breaking change)
- All existing Claude Code functionality unchanged
- Environment variables respected for override
- Gradual migration path for users

## Testing Strategy

### Unit Tests
- CLI detection logic
- CLI path finding
- Token retrieval for both CLIs

### Integration Tests
- Run task with Claude Code CLI
- Run task with OpenCode CLI
- Switch between CLIs
- OpenCode provider configuration

### Manual Tests
- Complete spec creation with OpenCode
- Complete task build with OpenCode
- Verify agent execution with different providers

## Next Steps

Proceed to **Step 2** to implement the CLI abstraction layer.
