# Step 6: Frontend IPC Handlers for CLI Selection

## Objective
Create IPC handlers for CLI selection, configuration, and validation in the Electron main process.

## Files to Create

### 1. Frontend: CLI Handlers Module

**File**: `apps/frontend/src/main/ipc-handlers/cli-handlers.ts` (NEW)

## Implementation

```typescript
/**
 * CLI IPC Handlers
 *
 * Handles IPC requests for CLI selection, configuration, and validation.
 * Supports both Claude Code CLI and OpenCode CLI.
 */

import { ipcMain } from 'electron';
import type { BrowserWindow } from 'electron';

// Types for CLI operations
export interface CLIInfo {
  type: 'claude' | 'opencode';
  path: string | null;
  isValid: boolean;
  version?: string;
  authInfo: CLIAuthInfo;
}

export interface CLIAuthInfo {
  type: 'oauth' | 'multi_provider';
  envVars: string[];
  supportsKeychain: boolean;
  requiresOAuth: boolean;
  providers?: string[]; // OpenCode only
}

export interface CLIValidationResult {
  isValid: boolean;
  message: string;
}

export interface CLISetOptions {
  cliType: 'claude' | 'opencode';
  opencodeProvider?: 'claude' | 'openai' | 'google' | 'zen' | 'local';
}

export interface CLIProvider {
  id: string;
  name: string;
  displayName: string;
  authType: 'oauth' | 'api_key';
}

// OpenCode providers (from OpenCode CLI)
const OPENCODE_PROVIDERS: CLIProvider[] = [
  {
    id: 'claude',
    name: 'claude',
    displayName: 'Claude',
    authType: 'oauth',
  },
  {
    id: 'openai',
    name: 'openai',
    displayName: 'ChatGPT (OpenAI)',
    authType: 'oauth',
  },
  {
    id: 'google',
    name: 'google',
    displayName: 'Google (Gemini)',
    authType: 'oauth',
  },
  {
    id: 'zen',
    name: 'zen',
    displayName: 'OpenCode Zen',
    authType: 'api_key',
  },
  {
    id: 'local',
    name: 'local',
    displayName: 'Local Models',
    authType: 'none',
  },
];

// Store for CLI configuration
let activeCLIType: 'claude' | 'opencode' = 'claude';
let activeOpenCodeProvider: string = 'claude';

/**
 * Get current CLI information
 */
async function getCLIInfo(): Promise<CLIInfo> {
  try {
    const { PythonEnvManager } = await import(
      '../python-env-manager'
    );

    const pythonEnvManager = PythonEnvManager.getInstance();
    const projectPath = pythonEnvManager.getProjectPath();

    if (!projectPath) {
      return {
        type: 'claude',
        path: null,
        isValid: false,
        authInfo: {
          type: 'oauth',
          envVars: ['CLAUDE_CODE_OAUTH_TOKEN'],
          supportsKeychain: true,
          requiresOAuth: true,
        },
      };
    }

    // Check CLI type from settings
    const { projectStore } = await import('../project-store');
    const settings = await projectStore.getSettings(projectPath);

    const cliType = settings.cli || 'claude';
    activeCLIType = cliType;

    // Get CLI path using Python
    const result = await pythonEnvManager.runPythonScript(`
import sys
import os
from pathlib import Path

project_dir = Path('${projectPath}')
settings_path = project_dir / '.auto-claude' / 'settings.json'

# Get CLI type
cli_type = 'claude'
if settings_path.exists():
    import json
    try:
        with open(settings_path) as f:
            settings = json.load(f)
        cli_type = settings.get('cli', 'claude')
    except:
        pass

# Get CLI path
cli_path = None
if cli_type == 'claude':
    import shutil
    cli_path = shutil.which('claude')
elif cli_type == 'opencode':
    cli_path = shutil.which('opencode')

# Validate CLI
is_valid = cli_path is not None
version = None
if is_valid:
    import subprocess
    result = subprocess.run([cli_path, '--version'], capture_output=True, text=True, timeout=5)
    if result.returncode == 0:
        version = result.stdout.strip() or result.stderr.strip()

import json
print(json.dumps({
    'cli_type': cli_type,
    'cli_path': cli_path,
    'is_valid': is_valid,
    'version': version,
    'opencode_provider': ${activeOpenCodeProvider if cli_type == 'opencode' else 'null'}
}, separators=(',', ': '))
`);

    const data = JSON.parse(result.stdout);

    return {
      type: data.cli_type as 'claude' | 'opencode',
      path: data.cli_path,
      isValid: data.is_valid,
      version: data.version,
      authInfo: getAuthInfoForCLI(data.cli_type, data.opencode_provider),
    };
  } catch (error) {
    console.error('Error getting CLI info:', error);
    return {
      type: 'claude',
      path: null,
      isValid: false,
      authInfo: {
        type: 'oauth',
        envVars: ['CLAUDE_CODE_OAUTH_TOKEN'],
        supportsKeychain: true,
        requiresOAuth: true,
      },
    };
  }
}

/**
 * Get authentication info for a CLI type
 */
function getAuthInfoForCLI(
  cliType: string,
  opencodeProvider: string | null,
): CLIAuthInfo {
  if (cliType === 'opencode') {
    return {
      type: 'multi_provider',
      envVars: ['OPENCODE_API_KEY', 'OPENCODE_PROVIDER'],
      supportsKeychain: true,
      requiresOAuth: false,
      providers: OPENCODE_PROVIDERS.map((p) => p.name),
    };
  }

  return {
    type: 'oauth',
    envVars: ['CLAUDE_CODE_OAUTH_TOKEN', 'ANTHROPIC_AUTH_TOKEN'],
    supportsKeychain: true,
    requiresOAuth: true,
  };
}

/**
 * Set active CLI type
 */
async function setCLIOptions(options: CLISetOptions): Promise<CLIInfo> {
  try {
    const { PythonEnvManager } = await import('../python-env-manager');
    const { projectStore } = await import('../project-store');

    const pythonEnvManager = PythonEnvManager.getInstance();
    const projectPath = pythonEnvManager.getProjectPath();

    if (!projectPath) {
      throw new Error('No active project');
    }

    // Get current settings
    const settings = await projectStore.getSettings(projectPath);

    // Update CLI type
    settings.cli = options.cliType;

    // Update OpenCode provider if OpenCode CLI
    if (options.cliType === 'opencode' && options.opencodeProvider) {
      if (!settings.opencode) {
        settings.opencode = {};
      }
      settings.opencode.provider = options.opencodeProvider;
      activeOpenCodeProvider = options.opencodeProvider;
    }

    // Save updated settings
    await projectStore.saveSettings(projectPath, settings);

    // Set environment variable for Python scripts
    process.env.CLI_PROVIDER = options.cliType;

    if (options.opencodeProvider) {
      process.env.OPENCODE_PROVIDER = options.opencodeProvider;
    }

    // Return updated CLI info
    return await getCLIInfo();
  } catch (error) {
    console.error('Error setting CLI options:', error);
    throw error;
  }
}

/**
 * Validate CLI availability
 */
async function validateCLI(): Promise<CLIValidationResult> {
  try {
    const cliInfo = await getCLIInfo();

    return {
      isValid: cliInfo.isValid,
      message: cliInfo.isValid
        ? `${cliInfo.type} CLI is working (version: ${cliInfo.version || 'unknown'})`
        : `${cliInfo.type} CLI validation failed: ${cliInfo.path ? 'not found' : 'not working'}`,
    };
  } catch (error) {
    return {
      isValid: false,
      message: `Error validating CLI: ${error}`,
    };
  }
}

/**
 * Get available OpenCode providers
 */
function getOpenCodeProviders(): CLIProvider[] {
  return OPENCODE_PROVIDERS;
}

/**
 * Register CLI IPC handlers
 */
export function registerCLIHandlers(getMainWindow: () => BrowserWindow | null): void {
  console.log('Registering CLI handlers');

  // CLI_GET_INFO - Get current CLI information
  ipcMain.handle('CLI_GET_INFO', async () => {
    try {
      const info = await getCLIInfo();
      return { success: true, data: info };
    } catch (error) {
      console.error('Error getting CLI info:', error);
      return { success: false, error: (error as Error).message };
    }
  });

  // CLI_SET_CLI - Set active CLI type and options
  ipcMain.handle('CLI_SET_CLI', async (_event, options: CLISetOptions) => {
    try {
      const info = await setCLIOptions(options);
      return { success: true, data: info };
    } catch (error) {
      console.error('Error setting CLI:', error);
      return { success: false, error: (error as Error).message };
    }
  });

  // CLI_VALIDATE_CLI - Validate CLI availability
  ipcMain.handle('CLI_VALIDATE_CLI', async () => {
    try {
      const result = await validateCLI();
      return { success: true, data: result };
    } catch (error) {
      console.error('Error validating CLI:', error);
      return { success: false, error: (error as Error).message };
    }
  });

  // CLI_GET_PROVIDERS - Get available OpenCode providers
  ipcMain.handle('CLI_GET_PROVIDERS', () => {
    try {
      const providers = getOpenCodeProviders();
      return { success: true, data: providers };
    } catch (error) {
      console.error('Error getting providers:', error);
      return { success: false, error: (error as Error).message };
    }
  });

  console.log('CLI handlers registered');
}
```

### 2. Frontend: Update IPC Channels

**File**: `apps/frontend/src/shared/constants/ipc-channels.ts` (or create if doesn't exist)

Add CLI-related IPC channels:

```typescript
/**
 * IPC Channel Names
 *
 * Centralized IPC channel definitions for type safety.
 */

// ... existing channels ...

export const IPC_CHANNELS = {
  // ... existing channels ...

  // CLI-related channels
  CLI_GET_INFO: 'CLI_GET_INFO',
  CLI_SET_CLI: 'CLI_SET_CLI',
  CLI_VALIDATE_CLI: 'CLI_VALIDATE_CLI',
  CLI_GET_PROVIDERS: 'CLI_GET_PROVIDERS',
} as const;
```

### 3. Frontend: Update Main IPC Index

**File**: `apps/frontend/src/main/ipc-handlers/index.ts`

Register CLI handlers:

```typescript
import { registerCLIHandlers } from './cli-handlers';

// ... existing imports and handler registrations ...

export function setupIpcHandlers(
  // ... existing parameters
): void {
  // ... existing handler registrations ...

  // NEW: Register CLI handlers
  registerCLIHandlers(getMainWindow);

  console.log('All IPC handlers registered');
}
```

## Testing

### Unit Test: `apps/frontend/src/main/ipc-handlers/__tests__/cli-handlers.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { ipcMain } from 'electron';
import { registerCLIHandlers } from '../cli-handlers';

describe('CLI Handlers', () => {
  beforeEach(() => {
    // Reset state
  });

  afterEach(() => {
    // Cleanup
  });

  it('should get CLI info successfully', async () => {
    const { getCLIInfo } = await import('../cli-handlers');
    const info = await getCLIInfo();

    expect(info.type).toBeDefined();
    expect(typeof info.type).toBe('string');
    expect(typeof info.path).toBe('string');
    expect(typeof info.isValid).toBe('boolean');
  });

  it('should set CLI options successfully', async () => {
    const { setCLIOptions } = await import('../cli-handlers');
    const result = await setCLIOptions({ cliType: 'opencode' });

    expect(result.success).toBe(true);
    expect(result.data).toHaveProperty('type');
  });

  it('should validate CLI', async () => {
    const { validateCLI } = await import('../cli-handlers');
    const result = await validateCLI();

    expect(result.success).toBe(true);
    expect(result.data).toHaveProperty('isValid');
    expect(result.data).toHaveProperty('message');
  });

  it('should get OpenCode providers', async () => {
    const { getOpenCodeProviders } = await import('../cli-handlers');
    const providers = getOpenCodeProviders();

    expect(Array.isArray(providers)).toBe(true);
    expect(providers.length).toBeGreaterThan(0);
    expect(providers[0]).toHaveProperty('id');
    expect(providers[0]).toHaveProperty('name');
    expect(providers[0]).toHaveProperty('displayName');
  });
});
```

### Integration Test

Test from renderer process:

```typescript
// In a test component or DevTools console
import type { IPCResult } from '@shared/types/ipc';

async function testCLIHandlers() {
  // Get CLI info
  const cliInfo = await window.electronAPI.cli.getInfo();
  console.log('CLI Info:', cliInfo);

  // Set CLI to OpenCode
  const setResult = await window.electronAPI.cli.setCLI({
    cliType: 'opencode',
    opencodeProvider: 'claude',
  });
  console.log('Set CLI result:', setResult);

  // Validate CLI
  const validationResult = await window.electronAPI.cli.validateCLI();
  console.log('Validation result:', validationResult);

  // Get OpenCode providers
  const providers = await window.electronAPI.cli.getProviders();
  console.log('OpenCode providers:', providers);
}
```

## Verification

Run these commands to verify implementation:

```bash
# Check TypeScript compilation
cd apps/frontend
npm run typecheck

# Run unit tests
npm test -- cli-handlers

# Build the app (quick test)
npm run build
```

## IPC Channel Summary

| Channel | Direction | Description |
|---------|-----------|-------------|
| `CLI_GET_INFO` | Renderer → Main | Get current CLI configuration |
| `CLI_SET_CLI` | Renderer → Main | Set CLI type and options |
| `CLI_VALIDATE_CLI` | Renderer → Main | Validate CLI availability |
| `CLI_GET_PROVIDERS` | Renderer → Main | Get available OpenCode providers |

## Important Notes

1. **Python Integration**: CLI handlers use Python scripts to detect CLI type and path
2. **Settings Persistence**: CLI configuration saved in `.auto-claude/settings.json`
3. **Environment Variables**: Set `CLI_PROVIDER` and `OPENCODE_PROVIDER` in process.env
4. **Error Handling**: All handlers return consistent error format `{ success, data/error }`
5. **Type Safety**: Full TypeScript types for all IPC data structures

## Next Steps

Proceed to **Step 7** to create CLI selector UI component.
