# Step 5: Add CLI Selection to run.py

## Objective
Update `apps/backend/cli/run.py` to support CLI selection via `--cli` flag and `CLI_PROVIDER` environment variable.

## Files to Modify

### 1. Backend: CLI run.py

**File**: `apps/backend/cli/run.py` (or `apps/backend/run.py`)

Add CLI argument for selecting which CLI to use.

## Implementation

### Add CLI Argument

Add a new `--cli` argument to the argument parser:

```python
import argparse
from pathlib import Path

# Existing imports...
from core.cli_manager import CLIType, get_cli_manager


def parse_arguments():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Auto Claude - Autonomous multi-agent coding framework",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    # Existing arguments
    parser.add_argument(
        "--spec",
        help="Spec number to run (e.g., 001)",
    )
    parser.add_argument(
        "--list",
        action="store_true",
        help="List all available specs",
    )
    parser.add_argument(
        "--qa",
        action="store_true",
        help="Run QA validation after build",
    )
    parser.add_argument(
        "--merge",
        action="store_true",
        help="Merge completed build",
    )
    parser.add_argument(
        "--review",
        action="store_true",
        help="Review build changes",
    )
    parser.add_argument(
        "--discard",
        action="store_true",
        help="Discard build",
    )
    parser.add_argument(
        "--direct",
        action="store_true",
        help="Run directly in repository (not isolated)",
    )
    parser.add_argument(
        "--isolated",
        action="store_true",
        help="Run in isolated workspace",
    )
    parser.add_argument(
        "--model",
        help="Override default model",
    )

    # NEW: CLI selection argument
    parser.add_argument(
        "--cli",
        choices=["claude", "opencode"],
        default=None,
        help="AI CLI to use (default: claude)",
    )

    parser.add_argument(
        "--info",
        action="store_true",
        help="Show CLI and authentication information",
    )

    return parser.parse_args()


def main():
    """Main entry point for Auto Claude CLI."""
    args = parse_arguments()

    # NEW: Handle --info flag
    if args.info:
        print_cli_and_auth_info()
        return

    # NEW: Set CLI_PROVIDER environment variable if --cli specified
    if args.cli:
        os.environ["CLI_PROVIDER"] = args.cli
        print(f"Using CLI: {args.cli}")
    else:
        # Check if CLI_PROVIDER is already set
        existing_cli = os.environ.get("CLI_PROVIDER", "")
        if existing_cli:
            print(f"Using CLI from environment: {existing_cli}")

    # Get project directory
    project_dir = Path.cwd()

    # NEW: Validate CLI availability
    from core.cli_manager import get_cli_manager
    cli_manager = get_cli_manager(project_dir)
    is_valid, validation_msg = cli_manager.validate_cli()

    if not is_valid:
        print(f"CLI Error: {validation_msg}")
        print("\nTo fix:")
        print("  1. Ensure the CLI is installed:")
        print("     - For Claude Code: npm install -g @anthropic-ai/claude-code")
        print("     - For OpenCode: npm install -g opencode-ai")
        print("  2. Verify it's in your PATH")
        sys.exit(1)

    # ... rest of the main function continues as before
```


### Add CLI Info Function

Add a new function to display CLI and authentication information:

```python
def print_cli_and_auth_info():
    """Print CLI and authentication configuration information."""
    from core.cli_manager import get_cli_manager
    from core.auth import (
        get_auth_token,
        get_auth_token_by_cli_type,
    )

    project_dir = Path.cwd()
    cli_manager = get_cli_manager(project_dir)
    cli_type = cli_manager.get_cli_type()

    print(f"\n{'=' * 60}")
    print("AUTO CLAUDE - CLI & AUTHENTICATION INFO")
    print(f"{'=' * 60}")
    print()

    # CLI Information
    print("CLI Configuration:")
    print(f"  Type: {cli_type.value}")
    cli_path = cli_manager.get_cli_path()
    print(f"  Path: {cli_path}")

    # Authentication Information
    print("\nAuthentication:")
    auth_info = cli_manager.get_auth_info()
    print(f"  Auth Type: {auth_info['type']}")

    # Show active auth token source
    token_source = None

    if cli_type == CLIType.OPENCODE:
        from core.auth import get_opencode_token
        token = get_opencode_token()

        if os.environ.get("OPENCODE_API_KEY"):
            token_source = "OPENCODE_API_KEY (environment variable)"
        elif token:
            token_source = "OpenCode config or keychain"
        else:
            token_source = "Not configured"
    else:
        token = get_auth_token()
        if os.environ.get("CLAUDE_CODE_OAUTH_TOKEN"):
            token_source = "CLAUDE_CODE_OAUTH_TOKEN (environment variable)"
        elif os.environ.get("ANTHROPIC_AUTH_TOKEN"):
            token_source = "ANTHROPIC_AUTH_TOKEN (API profile)"
        elif os.environ.get("ANTHROPIC_BASE_URL"):
            token_source = "ANTHROPIC_AUTH_TOKEN (API profile with custom endpoint)"
        elif token:
            token_source = "Keychain or .credentials.json"
        else:
            token_source = "Not configured"

    print(f"  Token Source: {token_source}")

    # Provider Information (for OpenCode)
    if cli_type == CLIType.OPENCODE:
        provider = cli_manager.get_opencode_provider()
        print(f"  OpenCode Provider: {provider.value}")

    # Model Information
    print("\nModel Configuration:")
    model = os.environ.get("AUTO_BUILD_MODEL")
    if model:
        print(f"  Model: {model}")
    else:
        print(f"  Model: (default for selected CLI)")

    print()
    print(f"{'=' * 60}\n")
```

## Usage Examples

### CLI with Claude Code (default)

```bash
# Run spec with Claude Code CLI (default)
python run.py --spec 001

# Run with QA
python run.py --spec 001 --qa

# Show info
python run.py --info
```

### CLI with OpenCode

```bash
# Run spec with OpenCode CLI
python run.py --spec 001 --cli opencode

# Set environment variable for default
export CLI_PROVIDER=opencode
python run.py --spec 001

# Run with OpenCode and specific provider
OPENCODE_PROVIDER=openai OPENCODE_API_KEY=sk-opc-... python run.py --spec 001 --cli opencode
```

## Update Help Text

The `--help` output should include:

```
usage: run.py [-h] [--spec SPEC] [--list] [--qa] [--merge] [--review]
               [--discard] [--direct] [--isolated] [--model MODEL]
               [--cli {claude,opencode}] [--info]

Auto Claude - Autonomous multi-agent coding framework

optional arguments:
  -h, --help            show this help message and exit
  --spec SPEC           Spec number to run (e.g., 001)
  --list                List all available specs
  --qa                   Run QA validation after build
  --merge                Merge completed build
  --review               Review build changes
  --discard              Discard build
  --direct               Run directly in repository (not isolated)
  --isolated             Run in isolated workspace
  --model MODEL          Override default model
  --cli {claude,opencode}
                        AI CLI to use (default: claude)
  --info                 Show CLI and authentication information
```

## Testing

### Unit Test: `tests/cli/test_run_cli_selection.py`

```python
import os
import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock, sys

import cli.run


class TestRunCLISelection:
    @patch("sys.argv")
    def test_default_cli_type(self, mock_argv, capsys):
        """Test default CLI type is Claude."""
        mock_argv.return_value = ["run.py", "--spec", "001"]

        with pytest.raises(SystemExit):
            cli.run.main()

        captured = capsys.readouterr()
        assert "claude" in os.environ.get("CLI_PROVIDER", "").lower()

    @patch("sys.argv")
    def test_explicit_claude_cli(self, mock_argv, capsys):
        """Test explicit Claude CLI selection."""
        mock_argv.return_value = ["run.py", "--cli", "claude", "--spec", "001"]

        with pytest.raises(SystemExit):
            cli.run.main()

        assert os.environ.get("CLI_PROVIDER") == "claude"

    @patch("sys.argv")
    def test_explicit_opencode_cli(self, mock_argv, capsys):
        """Test explicit OpenCode CLI selection."""
        mock_argv.return_value = ["run.py", "--cli", "opencode", "--spec", "001"]

        with pytest.raises(SystemExit):
            cli.run.main()

        assert os.environ.get("CLI_PROVIDER") == "opencode"

    @patch("sys.argv")
    @patch("cli.run.print_cli_and_auth_info")
    def test_info_flag(self, mock_argv, mock_print_info):
        """Test --info flag."""
        mock_argv.return_value = ["run.py", "--info"]

        with pytest.raises(SystemExit) as Exit:
            cli.run.main()

        mock_print_info.assert_called_once()

    @patch("sys.argv")
    @patch("cli.run.get_cli_manager")
    @patch("sys.exit")
    def test_invalid_cli_validation(self, mock_argv, mock_cli_mgr, mock_exit):
        """Test CLI validation fails with invalid CLI."""
        mock_argv.return_value = ["run.py", "--cli", "invalid"]

        mock_cli_mgr.return_value.validate_cli.return_value = (False, "CLI not found")

        cli.run.main()

        mock_exit.assert_called_once_with(1)
```

## Verification

Run these commands to verify the implementation:

```bash
# Test help output includes --cli flag
cd apps/backend/cli
python run.py --help

# Test --info flag
python run.py --info

# Test default CLI (Claude)
python run.py --info | grep "Type: claude"

# Test explicit Claude CLI
python run.py --cli claude --info | grep "Type: claude"

# Test OpenCode CLI
python run.py --cli opencode --info | grep "Type: opencode"

# Test environment variable
CLI_PROVIDER=opencode python run.py --info | grep "Type: opencode"

# Test invalid CLI
python run.py --cli invalid
# Should exit with error message

# Run unit tests
pytest tests/cli/test_run_cli_selection.py -v
```

## Important Notes

1. **Default Behavior**: If `--cli` is not specified, defaults to "claude"
2. **Environment Variable**: `CLI_PROVIDER` can override default
3. **Priority**: `--cli` flag > `CLI_PROVIDER` env var > default
4. **Backward Compatible**: Existing workflows unchanged (default is Claude)
5. **Validation**: CLI is validated before running any operations

## Next Steps

Proceed to **Step 6** to create frontend IPC handlers for CLI selection.
