# Step 4: Integrate OpenCode CLI with Client Creation

## Objective
Update `create_client()` in `core/client.py` to work with either Claude Code CLI or OpenCode CLI based on CLI selection.

## Files to Modify

### 1. Backend: Update client.py

**File**: `apps/backend/core/client.py`

The main changes needed:

1. Import `CLIManager` and `CLIType` from `core.cli_manager`
2. Detect CLI type from CLIManager
3. Use appropriate CLI configuration for SDK
4. Handle OpenCode-specific settings

## Implementation

### Add CLI Manager Import

At the top of `client.py`, add:

```python
from core.cli_manager import (
    CLIManager,
    CLIType,
    get_cli_manager as _get_cli_manager,
)
```

### Update `create_client()` Function

Modify the `create_client()` function to use CLI Manager:

```python
def create_client(
    project_dir: Path,
    spec_dir: Path,
    model: str,
    agent_type: str = "coder",
    max_thinking_tokens: int | None = None,
    output_format: dict | None = None,
    agents: dict | None = None,
) -> ClaudeSDKClient:
    """
    Create a Claude Agent SDK client with multi-layered security.

    Supports both Claude Code CLI and OpenCode CLI.
    CLI selection determined by CLIManager.

    Args:
        project_dir: Root directory for project (working directory)
        spec_dir: Directory containing spec (for settings file)
        model: Claude model to use
        agent_type: Agent type identifier (e.g., 'coder', 'planner', 'qa_reviewer')
        max_thinking_tokens: Token budget for extended thinking
        output_format: Optional structured output format for validated JSON responses
        agents: Optional dict of subagent definitions for SDK parallel execution

    Returns:
        Configured ClaudeSDKClient

    Raises:
        ValueError: If agent_type is not found in AGENT_CONFIGS
    """
    # Initialize CLI manager to detect which CLI to use
    cli_manager = _get_cli_manager(project_dir)
    cli_type = cli_manager.get_cli_type()
    cli_path = cli_manager.get_cli_path()

    # Validate CLI is available
    is_valid, validation_msg = cli_manager.validate_cli()
    if not is_valid:
        raise ValueError(f"CLI validation failed: {validation_msg}")

    # Log CLI configuration
    debug = os.environ.get("DEBUG", "").lower() in ("true", "1")
    if debug:
        from core.cli_manager import print_cli_info
        print_cli_info(cli_manager)

    # Collect env vars to pass to SDK (ANTHROPIC_BASE_URL, etc.)
    sdk_env = get_sdk_env_vars()

    # Get config dir for profile-specific credential lookup
    config_dir = sdk_env.get("CLAUDE_CONFIG_DIR")

    # Configure SDK authentication based on CLI type
    if cli_type == CLIType.OPENCODE:
        configure_opencode_sdk_authentication(config_dir)
    else:
        configure_sdk_authentication(config_dir)

    if config_dir:
        logger.info(f"Using CLAUDE_CONFIG_DIR for profile: {config_dir}")

    # ... rest of the function continues as before ...
```

### Add OpenCode SDK Configuration Function

Add new function for OpenCode-specific SDK configuration:

```python
def configure_opencode_sdk_authentication(config_dir: str | None = None) -> None:
    """
    Configure SDK authentication for OpenCode CLI.

    OpenCode uses API keys or OAuth from multiple providers.
    We need to configure environment variables appropriately.

    Args:
        config_dir: Optional profile config directory (for future multi-profile support)

    Note:
        Currently, OpenCode CLI handles its own authentication internally.
        We just need to ensure OpenCode is configured properly.
    """
    # Get OpenCode token
    from core.auth import get_opencode_token
    token = get_opencode_token(config_dir)

    if not token:
        # OpenCode is CLI-based, token may be stored in OpenCode's config
        logger.warning("No OpenCode token found, but OpenCode CLI may have its own auth")
        return

    # For OpenCode, we may need to set different env vars
    # depending on the configured provider
    provider = os.environ.get("OPENCODE_PROVIDER", "claude")

    # Note: OpenCode CLI handles its own model selection
    # We don't need to override model selection for OpenCode

    logger.info(f"Configuring OpenCode SDK with provider: {provider}")
```

### Modify `configure_sdk_authentication()` to support CLI type

Update the existing `configure_sdk_authentication()` to accept CLI type:

```python
def configure_sdk_authentication(
    config_dir: str | None = None,
    cli_type: CLIType | None = None,
) -> None:
    """
    Configure SDK authentication based on CLI type and environment.

    Supports two authentication modes:
    - API Profile mode (ANTHROPIC_BASE_URL set): uses ANTHROPIC_AUTH_TOKEN
    - OAuth mode (default): uses CLAUDE_CODE_OAUTH_TOKEN
    - OpenCode mode: uses OPENCODE_API_KEY

    Args:
        config_dir: Optional profile config directory for per-profile Keychain lookup
        cli_type: Optional CLI type (CLAUDE or OPENCODE)

    Raises:
        ValueError: If required tokens are missing for active mode
    """
    # Determine CLI type if not provided
    if cli_type is None:
        from core.cli_manager import CLIType
        cli_type_str = os.environ.get("CLI_PROVIDER", "").strip().lower()
        cli_type = CLIType.CLAUDE if cli_type_str != "opencode" else CLIType.OPENCODE

    api_profile_mode = bool(os.environ.get("ANTHROPIC_BASE_URL", "").strip())

    if cli_type == CLIType.OPENCODE:
        # OpenCode mode
        from core.auth import get_opencode_token, require_auth_token
        oauth_token = get_opencode_token(config_dir)

        if not oauth_token:
            # OpenCode CLI handles its own auth, but for SDK:
            raise ValueError(
                "No OpenCode authentication found.\n\n"
                "To authenticate:\n"
                "  1. Run: opencode login\n"
                "  2. Choose your provider (GitHub Copilot, ChatGPT, OpenCode Zen, API Key)\n"
                "The token will be saved automatically by OpenCode."
            )

        # Validate token is not encrypted (OpenCode uses plaintext or its own encryption)
        from core.auth import is_encrypted_token, validate_token_not_encrypted
        validate_token_not_encrypted(oauth_token)

        # Set SDK env var for OpenCode
        os.environ["CLAUDE_CODE_OAUTH_TOKEN"] = oauth_token
        logger.info("Using OpenCode authentication")

    elif api_profile_mode:
        # API profile mode: ensure ANTHROPIC_AUTH_TOKEN is present
        if not os.environ.get("ANTHROPIC_AUTH_TOKEN"):
            raise ValueError(
                "API profile mode active (ANTHROPIC_BASE_URL is set) "
                "but ANTHROPIC_AUTH_TOKEN is not set"
            )
        # Explicitly remove CLAUDE_CODE_OAUTH_TOKEN so SDK uses ANTHROPIC_AUTH_TOKEN
        os.environ.pop("CLAUDE_CODE_OAUTH_TOKEN", None)
        logger.info("Using API profile authentication")
    else:
        # OAuth mode: require and validate OAuth token
        from core.auth import require_auth_token
        oauth_token = require_auth_token(config_dir)

        # Validate token is not encrypted
        from core.auth import is_encrypted_token, validate_token_not_encrypted
        validate_token_not_encrypted(oauth_token)

        # Ensure SDK can access it via its expected env var
        os.environ["CLAUDE_CODE_OAUTH_TOKEN"] = oauth_token
        logger.info("Using OAuth authentication")
```

## Integration Points

### In `create_client()` Function

The `create_client()` function will now:

1. Initialize `CLIManager` to detect CLI type
2. Validate selected CLI is available
3. Configure authentication based on CLI type
4. Log which CLI and provider are being used
5. Continue with security settings, MCP servers, etc.

### Environment Variables

The system will now respect:

| Variable | Claude Mode | OpenCode Mode |
|-----------|--------------|---------------|
| `CLI_PROVIDER` | "claude" | "opencode" |
| `CLAUDE_CODE_OAUTH_TOKEN` | ✓ Primary | Used for SDK compatibility |
| `ANTHROPIC_AUTH_TOKEN` | ✓ Fallback | - |
| `OPENCODE_API_KEY` | - | ✓ Primary |
| `OPENCODE_PROVIDER` | - | ✓ Provider selection |
| `CLAUDE_CONFIG_DIR` | ✓ | ✓ (future) |

## Testing

### Unit Test: `tests/core/test_client_cli_integration.py`

```python
import os
import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock

from core.client import create_client
from core.cli_manager import CLIType


class TestClientCLIIntegration:
    @patch("core.client.ClaudeSDKClient")
    def test_create_client_with_claude_cli(self, mock_sdk_class, tmp_path):
        """Test client creation with Claude Code CLI."""
        os.environ["CLI_PROVIDER"] = "claude"

        # Mock SDK client creation
        mock_client = MagicMock()
        mock_sdk_class.return_value = mock_client

        client = create_client(
            project_dir=tmp_path,
            spec_dir=tmp_path,
            model="claude-sonnet-4-20250514",
            agent_type="coder",
        )

        assert mock_sdk_class.called
        # Verify Claude authentication was configured

    @patch("core.client.ClaudeSDKClient")
    def test_create_client_with_opencode_cli(self, mock_sdk_class, tmp_path):
        """Test client creation with OpenCode CLI."""
        os.environ["CLI_PROVIDER"] = "opencode"
        os.environ["OPENCODE_API_KEY"] = "sk-opc-test-key"

        # Mock SDK client creation
        mock_client = MagicMock()
        mock_sdk_class.return_value = mock_client

        client = create_client(
            project_dir=tmp_path,
            spec_dir=tmp_path,
            model="claude-sonnet-4-20250514",
            agent_type="coder",
        )

        assert mock_sdk_class.called
        # Verify OpenCode authentication was configured

    def test_create_client_with_invalid_cli(self, tmp_path):
        """Test client creation with invalid CLI."""
        os.environ["CLI_PROVIDER"] = "invalid-cli"

        with pytest.raises(ValueError, match="CLI validation failed"):
            create_client(
                project_dir=tmp_path,
                spec_dir=tmp_path,
                model="claude-sonnet-4-20250514",
                agent_type="coder",
            )

    @patch("core.client.ClaudeSDKClient")
    def test_create_client_with_opencode_provider(self, mock_sdk_class, tmp_path):
        """Test client creation with OpenCode provider configuration."""
        os.environ["CLI_PROVIDER"] = "opencode"
        os.environ["OPENCODE_PROVIDER"] = "openai"

        # Mock SDK client creation
        mock_client = MagicMock()
        mock_sdk_class.return_value = mock_client

        client = create_client(
            project_dir=tmp_path,
            spec_dir=tmp_path,
            model="claude-sonnet-4-20250514",
            agent_type="coder",
        )

        assert mock_sdk_class.called
```

## Verification

Run these commands to verify the implementation:

```bash
# Test client creation with Claude CLI
cd apps/backend
python3 -c "
from pathlib import Path
from core.client import create_client
try:
    client = create_client(
        Path('.'),
        Path('.'),
        'claude-sonnet-4-20250514',
        'coder'
    )
    print('✓ Claude CLI client created successfully')
except Exception as e:
    print(f'Error: {e}')
"

# Test client creation with OpenCode CLI
OPENCODE_API_KEY=sk-opc-test python3 -c "
from pathlib import Path
from core.client import create_client
try:
    client = create_client(
        Path('.'),
        Path('.'),
        'claude-sonnet-4-20250514',
        'coder'
    )
    print('✓ OpenCode CLI client created successfully')
except Exception as e:
    print(f'Error: {e}')
"

# Run unit tests
pytest tests/core/test_client_cli_integration.py -v
```

## Important Notes

1. **OpenCode CLI Compatibility**: The OpenCode CLI must be installed and available in PATH
2. **Token Management**: OpenCode manages its own tokens; we only read them
3. **Model Selection**: OpenCode CLI handles model selection internally
4. **SDK Compatibility**: The Claude Agent SDK is compatible with OpenCode when configured correctly
5. **Backward Compatible**: Default remains Claude Code CLI (no breaking change)

## Next Steps

Proceed to **Step 5** to add CLI selection to CLI `run.py` and implement --cli flag.
